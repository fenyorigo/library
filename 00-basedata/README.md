üìö BookCatalog ‚Äì Rebuild, Images & QC

This repository contains a fully automated, reproducible pipeline to:
	‚Ä¢	rebuild the BookCatalog MySQL schema and load stage data,
	‚Ä¢	map normalized cover images to books,
	‚Ä¢	copy images into the web app‚Äôs public/uploads/<book_id>/ tree,
	‚Ä¢	keep DB ‚Üî disk in sync, and
	‚Ä¢	generate QC reports.

All steps are idempotent and can be re-run at any time.

‚∏ª

Architecture Overview

The BookCatalog application follows a simple, explicit architecture, optimized for long-term maintainability and data integrity rather than complexity.

High-level components
+-------------------+
|   Web Browser     |
|  (Admin / Reader) |
+---------+---------+
          |
          v
+-------------------+
|  PHP Application  |
|  (public/)        |
|  - routing        |
|  - auth           |
|  - backup logic   |
+---------+---------+
          |
          v
+-------------------+
|     MySQL DB      |
|   (bpbooks)       |
+-------------------+

Filesystem:
- public/uploads/        ‚Üí cover images
- 00-basedata/           ‚Üí SQL helpers, scripts, QC reports
- ~/bin/                 ‚Üí operational & backup scripts

Backend
	‚Ä¢	Implemented in PHP
	‚Ä¢	Handles:
	‚Ä¢	authentication and authorization
	‚Ä¢	catalog CRUD operations
	‚Ä¢	backup orchestration
	‚Ä¢	All security-sensitive logic (auth, role checks, backup access) is enforced server-side

Database
	‚Ä¢	MySQL database (bpbooks)
	‚Ä¢	Authoritative source for:
	‚Ä¢	book metadata
	‚Ä¢	user accounts and roles
	‚Ä¢	Backed up independently via mysqldump

Frontend
	‚Ä¢	Frontend source lives under frontend/
	‚Ä¢	Built artifacts are deployed to public/dist
	‚Ä¢	Build output is not part of backups (rebuildable)

Static assets
	‚Ä¢	Book cover images are stored in:
	public/uploads/
	‚Ä¢	These are considered data, not build artifacts, and are always backed up

Operational tooling
	‚Ä¢	Backup and maintenance scripts live in:
	~/bin/
	
Release & Versioning Policy

The BookCatalog project uses a lightweight, pragmatic versioning model.

Versioning scope

Versioning applies primarily to:
	‚Ä¢	database schema changes
	‚Ä¢	backend logic changes
	‚Ä¢	data import/export processes
	‚Ä¢	backup format changes

Frontend-only changes may be versioned implicitly with the application.

Recommended version format
	MAJOR.MINOR.PATCH

	‚Ä¢	MAJOR ‚Äì incompatible changes (schema changes, auth model changes)
	‚Ä¢	MINOR ‚Äì backward-compatible feature additions
	‚Ä¢	PATCH ‚Äì bug fixes, small improvements
	Example:
	1.2.0 ‚Üí new catalog feature
	1.2.1 ‚Üí bug fix
	2.0.0 ‚Üí schema or auth change

Database changes
	‚Ä¢	Database schema changes should be:
	‚Ä¢	scripted (SQL files)
	‚Ä¢	stored under 00-basedata/sql/
	‚Ä¢	Any schema change should be documented briefly in the README or a CHANGELOG

Releases

A release typically consists of:
	1.	Updated application source
	2.	Updated database schema (if applicable)
	3.	Updated README (if operational behavior changed)
	4.	A successful backup test

Releases do not require:
	‚Ä¢	rebuilding historical backups
	‚Ä¢	modifying existing data unless explicitly required

Backward compatibility
	‚Ä¢	Existing backups must remain restorable
	‚Ä¢	If backup format or restore procedure changes, the README must be updated accordingly

Operational rule

If a future restore requires guesswork, the release is incomplete.

‚öôÔ∏è Requirements
	‚Ä¢	macOS or Linux
	‚Ä¢	Bash 4+ (5+ recommended)
	‚Ä¢	MySQL 8.x (with local_infile=ON)
	‚Ä¢	jq (optional, for JSON inspection)

Normalized cover corpus in normalized_covers/ with filenames like:

normalized_covers/00001_cover.jpg
normalized_covers/00002_cover.jpg

Web uploads directory used by the app:

public/uploads/<book_id>/cover.jpg
public/uploads/<book_id>/cover-thumb.jpg

Optional environment variables
You may export these before running the pipeline:

export PROJECT_ROOT=~/Projects/BookCatalog
export DB=bpbooks
export USER=bajanp
export UPLOADS="$PROJECT_ROOT/public/uploads"
export SRC=/Users/bajanp/Downloads/add-images-to-db/normalized_covers
export PIPELINE=sql   # or 'legacy'

Defaults live in scripts/env.sh (PROJECT_ROOT, BASEDATA_ROOT, ROOT, UPLOADS).
Override any of them by exporting before you run the scripts.

Passwords: the scripts honor $MYSQL_PWD if exported; 
otherwise you‚Äôll be prompted once at start and the value is reused by child scripts.

‚∏ª

üìÇ Repository Layout

scripts/
  00_gen_normalized_list.sh
  10_rebuild_db.sh
  20_load_norm_files_and_map_sql.sh
  30_clean_uploads.sh
  40_copy_covers_from_map.sh
  45_sync_db_to_disk.sh
  47_safe_prune_map.sh
  50_qc.sh
  run_all.sh

sql/
  00_rebuild_schema.sql
  10_load_stage.sql
  20_merge_books_publishers.sql
  30_merge_authors_and_links.sql
  40_build_img_map_and_update.sql
  50_sanity_checks.sql

normalized_covers/                # image corpus (input)
normalized_filenames.txt          # generated by step 00
public/uploads/                   # web app output tree

üöÄ Quickstart

Full rebuild (schema + stage + merge + mapping + copy + QC)

./scripts/run_all.sh full

Covers-only pass (keep DB, redo mapping ‚Üí copy ‚Üí QC)

./scripts/run_all.sh covers

üîÑ Pipeline Overview

The run_all.sh orchestrates these steps:

00 ‚Äî Generate normalized_filenames.txt
Script: 00_gen_normalized_list.sh
	‚Ä¢	Scans normalized_covers/
	‚Ä¢	Extracts *_cover.jpg filenames
	‚Ä¢	Writes a sorted list to normalized_filenames.txt
	‚Ä¢	Used later for bulk SQL loading

Scans normalized_covers/, extracts *_cover.jpg entries, writes a sorted list for bulk SQL load.

10 ‚Äî Rebuild DB schema & import stage data (FULL mode only)
Script: 10_rebuild_db.sh
	‚Ä¢	Recreates schema
	‚Ä¢	Loads stage tables
	‚Ä¢	Merges Books, Publishers, Authors, Book‚ÜîAuthor Links
	‚Ä¢	Calculates any helper keys (e.g., csv_book_id)

20 ‚Äî Load normalized names & build tmp_img_map (preferred ‚Äúsql‚Äù pipeline)
Script: 20_load_norm_files_and_map_sql.sh
	‚Ä¢	Creates/truncates tmp_norm_files
	‚Ä¢	LOAD DATA from normalized_filenames.txt
	‚Ä¢	Builds tmp_img_map via:
	‚Ä¢	direct csv_book_id ‚Üí csv_id
	‚Ä¢	single-occurrence title matches
	‚Ä¢	unique (title, publisher) matches
	‚Ä¢	Preps DB for clean copy:
			Books.cover_image = uploads/<book_id>/cover.jpg
			Books.cover_thumb = uploads/<book_id>/cover.jpg (temporary until real thumbs exist)
This is the preferred, deterministic SQL-centric pipeline.

47 ‚Äî Safe prune map to disk reality
Script: 47_safe_prune_map.sh
	‚Ä¢	Scans actual files on disk
	‚Ä¢	Builds tmp_have_file from actual files
	‚Ä¢	Removes from tmp_img_map any mapping without an on-disk file
üõ°Ô∏è Guarantees:
	‚Ä¢	Nothing is deleted from disk
	‚Ä¢	The mapping table remains trustworthy

45 ‚Äî Sync DB cover fields to disk
Script: 45_sync_db_to_disk.sh
	‚Ä¢	Sets cover_* = NULL for books without files
	‚Ä¢	Re-stamps cover_* for books with files
(Ensures DB reflects reality after prune)

30 ‚Äî Clean uploads
Script: 30_clean_uploads.sh
	‚Ä¢	Clears public/uploads/ to start copying cleanly
	‚Ä¢	Ensures copying starts from a clean state

40 ‚Äî Copy covers
Script: 40_copy_covers_from_map.sh
	‚Ä¢	Copies normalized_covers/<pad>_cover.jpg ‚Üí public/uploads/<book_id>/cover.jpg
	‚Ä¢	(Thumbnails handled by PHP utilities below)
Thumbnails are handled separately by PHP utilities

50 ‚Äî QC (reports saved to ~/Downloads/)
Script: 50_qc.sh

Produces on-screen stats and saves reports to ~/Downloads/:
Outputs:
	‚Ä¢	totals (DB books, mapped rows, files on disk, with covers)
	‚Ä¢	orphan_files.txt (files with no matching book)
	‚Ä¢	books_missing_covers.tsv
	‚Ä¢	mapped_without_file.txt (mapped but file missing)
	‚Ä¢	top_publishers_missing.tsv (publishers with most missing covers)
	‚Ä¢	top_single_title_missing.tsv (unique titles still missing covers)

‚∏ª

üñºÔ∏è Cover Images & Thumbnails

The app and scripts use deterministic filenames:

public/uploads/<book_id>/cover.jpg
public/uploads/<book_id>/cover-thumb.jpg

Any legacy cover-<random>.* names are normalized automatically.

PHP utilities (run from repo root)

Image backend
Imagick is preferred; GD is used as a fallback.

1) Generate thumbnails (downscale only; no upscaling)

php public/generate_thumbs.php --height=240          # default 240px tall thumbs
php public/generate_thumbs.php --height=200 --force  # rebuild even if thumb exists
php public/generate_thumbs.php --dry-run             # preview actions

2) Normalize covers (rename legacy ‚Üí deterministic + update DB)
Renames any cover-<hash>.* ‚Üí cover.* (and thumbs likewise),
updates Books.cover_image and Books.cover_thumb, and cleans leftovers.

# CLI
php public/normalize_covers.php --dry-run
php public/normalize_covers.php --re               # force re-thumb
php public/normalize_covers.php --h=240            # custom thumb height
php public/normalize_covers.php --dry-run --h=200

# Browser
http://localhost/normalize_covers.php?dry=0&re=1&h=240

3) Rebuild thumbs for everything (slow & sure)

# Browser (example; limit=0 means ‚Äúno limit‚Äù)
http://localhost/rebuild_thumbs.php?limit=0&h=240&re=1

Notes
	‚Ä¢	Thumbs are only downscaled. If a cover is already ‚â§ requested size, it‚Äôs copied as-is.
	‚Ä¢	‚ÄúNormalize‚Äù does not change image dimensions‚Äîonly filenames and DB paths.
	‚Ä¢	Uploads via the UI now overwrite to the deterministic names and regenerate the thumb.

‚∏ª

üîß App Endpoints (selected)
	‚Ä¢	backup_full.php ‚Äì creates a ZIP with CSVs + uploads/ subset and a checksum manifest
	‚Ä¢	export_books_csv.php ‚Äì flat CSV export
	‚Ä¢	export_covers_zip.php ‚Äì ZIP of uploads/ (all covers + thumbnails)
	‚Ä¢	import_csv.php ‚Äì CSV import (title;subtitle;year_published;authors)
	‚Ä¢	list_books.php ‚Äì paginated/searchable list API (authors now include multiple names; order via Books_Authors.author_ord)
	‚Ä¢	addBook.php, update_book.php, delete_book.php ‚Äì CRUD
	‚Ä¢	upload_image.php, delete_image.php ‚Äì cover image ops (deterministic filenames)

‚∏ª

üß™ CSV Import (frontend or curl)

CSV shape:

title;subtitle;year_published;authors
Teszt k√∂nyv 01;Subtitle A;2024;Beke Albert
Teszt k√∂nyv 05;Multi author;1950;J. S. Bach; Albert Schweitzer
Teszt k√∂nyv 06;Empty year;;Author One; Author Two
‚Ä¶

	‚Ä¢	Separator: ;
	‚Ä¢	Authors last (important). Multiple authors may be separated by ; or ,
	‚Ä¢	Empty fields allowed (year is stored as NULL, not 0)

Endpoints:

# Dry run
curl -s -F 'file=@/path/to/file.csv' -F 'dry_run=1' http://localhost/import_csv.php

# Import
curl -s -F 'file=@/path/to/file.csv' -F 'dry_run=0' http://localhost/import_csv.php

ü©∫ Troubleshooting

Empty UI, but API returns rows
	Update the Vue templates to reflect any schema changes or new fields. The JSON is source of truth.

LOAD DATA LOCAL fails
	Enable in MySQL configs:

	[mysqld]
	local_infile=ON

	[client]
	local_infile=ON

Permissions
	Ensure the web process can read/write uploads:

	chmod -R u+rw public/uploads

Books with covers ‚â† files on disk ‚â† map entries?

	Run, in order:
	1.	47_safe_prune_map.sh
	2.	45_sync_db_to_disk.sh
	3.	50_qc.sh

‚úÖ Status
	‚Ä¢	Deterministic and repeatable
	‚Ä¢	Safe to re-run
	‚Ä¢	DB and disk always converge to a consistent state
	‚Ä¢	Rich QC artifacts after every run

üßπ Temporary / Work Tables

The following tables are pipeline artifacts only and may be dropped at any time:
	‚Ä¢	tmp_*
	‚Ä¢	stage_*

They are recreated automatically by rebuild, mapping, or QC scripts and are not part of the authoritative dataset.

To remove all work tables safely:
	mysql bpbooks < sql/cleanup_work_tables.sql

‚úÖ Restore plan ‚Äî validated

Restore flow is correct and sound:
	1.	Backup old public/uploads/
	2.	Restore uploads from catalog backup
	3.	Import full mysqldump (drops & recreates tables)
	4.	Restart DB (optional but clean)
	5.	Run 50_qc.sh

üí° And now, optionally:
	Run cleanup_work_tables.sql if you want a pristine DB

‚úÖ Backup

The BookCatalog project uses two complementary backup strategies, serving different recovery scenarios.

1) Data Backup (Database ‚Äì authoritative source)

The database is backed up independently using a dedicated script.
This guarantees that the entire catalog data can be recreated 100%, regardless of application state.

Script
	~/bin/backup_bpbooks.sh

What it does
	‚Ä¢	Creates a compressed mysqldump of the bpbooks database
	‚Ä¢	Includes routines, triggers, and events
	‚Ä¢	Uses --single-transaction for consistency
	‚Ä¢	Rotates old backups automatically (keeps last N dumps)

Output location
	~/Backups/bpbooks/bpbooks-YYYYMMDD-HHMMSS.sql.gz

This backup is the primary data safety net.

‚∏ª

2) Project Snapshot Backup (Application + helpers)

A second backup captures the project state and operational tooling.

Script
	~/bin/backup_bookcatalog.sh

Included
	‚Ä¢	Project source (~/Projects/BookCatalog)
	‚Ä¢	00-basedata/ (SQL helpers, scripts, QC reports)
	‚Ä¢	public/uploads/ (book cover images)
	‚Ä¢	~/bin/ (operational scripts, including backup tooling)

Explicitly excluded
	‚Ä¢	frontend/node_modules/
	‚Ä¢	public/dist/
	‚Ä¢	downloaded-covers/
	‚Ä¢	.git/, IDE folders, build artifacts

Output
	~/Backups/bookcatalog/bookcatalog-YYYYMMDD-HHMMSS.tgz
	~/Backups/bookcatalog/bookcatalog-YYYYMMDD-HHMMSS.tgz.sha256
	
This backup is intended for:
	‚Ä¢	disaster recovery
	‚Ä¢	environment reconstruction
	‚Ä¢	historical reference

‚∏ª

Recommended restore order
	1.	Restore database from bpbooks-*.sql.gz
	2.	Restore public/uploads/ from project snapshot
	3.	Deploy application source
	4.	Rebuild frontend if needed (public/dist is intentionally excluded)

‚∏ª

‚úÖ Authentication & User Management

User management is handled via a CLI helper script.
This avoids manual database manipulation and ensures consistent user creation.

Creating a user

Run from the project root:
	php public/create_user.php 'username' 'YourStrongPassword' admin

or for a read-only user:
	php public/create_user.php 'username' 'YourStrongPassword' reader

Roles
	‚Ä¢	admin
	‚Ä¢	Full access
	‚Ä¢	Can trigger backups
	‚Ä¢	Can manage catalog data
	‚Ä¢	reader
	‚Ä¢	Read-only access
	‚Ä¢	No administrative actions
	‚Ä¢	Backup actions are blocked server-side

Notes
	‚Ä¢	Passwords are stored hashed (never in clear text)
	‚Ä¢	Password policy: min 12 chars, 1 lowercase, 1 uppercase, 1 digit, 1 special
	‚Ä¢	Role checks are enforced on the backend
	‚Ä¢	UI elements may be hidden for non-admins, but authorization is always verified server-side
	‚Ä¢	Break-glass user creation: `public/create_user.php` is the emergency path if UI login fails

Auth event logging
	‚Ä¢	Auth events are stored in an append-only `AuthEvents` table
	‚Ä¢	See `00-basedata/auth_events.sql` for the table definition
	‚Ä¢	Recommended retention: keep 6‚Äì12 months via scheduled purge

‚úÖ Security Notes

This project follows a minimal but explicit security model, appropriate for a self-hosted catalog application.

Password handling
	‚Ä¢	Passwords are never stored in clear text
	‚Ä¢	Passwords are hashed at user creation time
	‚Ä¢	Only the hash is stored in the database
	‚Ä¢	The application never logs or exposes passwords
	‚Ä¢	Hardened session cookies set `HttpOnly`, `SameSite=Lax`, and `Secure` when HTTPS is enabled

The exact hashing algorithm is defined in the backend authentication code and can be changed centrally if needed.

Role-based access control (RBAC)

Two roles exist:
	‚Ä¢	admin
	‚Ä¢	Full read/write access
	‚Ä¢	Can trigger backups
	‚Ä¢	Can manage users and catalog data
	‚Ä¢	reader
	‚Ä¢	Read-only access
	‚Ä¢	Administrative endpoints are blocked

Enforcement model
	‚Ä¢	Authorization is enforced server-side
	‚Ä¢	UI visibility (buttons, menus) is considered cosmetic only
	‚Ä¢	All sensitive endpoints (e.g. backup) verify the user role explicitly

This ensures that even if a user manually crafts a request, unauthorized actions are rejected.

Operational scripts
	‚Ä¢	Backup and maintenance scripts live in ~/bin
	‚Ä¢	These scripts are not web-accessible
	‚Ä¢	They are included in project snapshot backups for reproducibility

Secrets & configuration
	‚Ä¢	Database credentials and secrets must not be committed to version control
	‚Ä¢	Configuration files containing secrets should be:
	‚Ä¢	injected via environment variables, or
	‚Ä¢	stored outside the project root

‚úÖ Disaster Recovery ‚Äì Checklist

This checklist describes how to recover the BookCatalog system from backups.

Prerequisites
	‚Ä¢	Working system with:
	‚Ä¢	PHP
	‚Ä¢	MySQL
	‚Ä¢	required PHP extensions
	‚Ä¢	Access to backup files:
	‚Ä¢	database dump (bpbooks-*.sql.gz)
	‚Ä¢	project snapshot (bookcatalog-*.tgz)
	‚Ä¢	Correct file permissions on the target system

‚∏ª

Step 1 ‚Äì Restore the database
	gunzip -c bpbooks-YYYYMMDD-HHMMSS.sql.gz | mysql bpbooks

	Verify:
	‚Ä¢	tables exist
	‚Ä¢	row counts look plausible
	‚Ä¢	no errors during import

Step 2 ‚Äì Restore project snapshot
	tar -xzf bookcatalog-YYYYMMDD-HHMMSS.tgz -C /target/path


	This restores:
	‚Ä¢	application source
	‚Ä¢	00-basedata/
	‚Ä¢	public/uploads/ (book covers)
	‚Ä¢	operational scripts under bin/

‚∏ª

Step 3 ‚Äì Restore uploads permissions

Ensure the web server can read uploaded covers:
	chown -R www-data:www-data public/uploads
	chmod -R 755 public/uploads

(adjust user/group as appropriate)

‚∏ª

Step 4 ‚Äì Rebuild frontend (if applicable)

public/dist is intentionally not part of the backup.

If the frontend is used:
	cd frontend
	npm install
	npm run build

Deploy the resulting build into public/dist.

‚∏ª

Step 5 ‚Äì Verify authentication
	‚Ä¢	Create or re-create admin user if needed:
	php public/create_user.php admin StrongPassword admin
	
	‚Ä¢	Log in as:
	‚Ä¢	admin (full access)
	‚Ä¢	reader (verify restrictions)

‚∏ª

Step 6 ‚Äì Sanity checks
	‚Ä¢	Open the catalog UI
	‚Ä¢	Verify book list loads
	‚Ä¢	Spot-check cover images
	‚Ä¢	Trigger a test backup (admin)
	‚Ä¢	Confirm backup file is valid (unzip -t)

‚∏ª

Recovery complete

At this point:
	‚Ä¢	catalog data is restored
	‚Ä¢	covers are available
	‚Ä¢	application is operational
	‚Ä¢	backups are functional again
	

Migrating from macos Tahoe to Fedora Core 43 server

1Ô∏è‚É£ Component mapping (macOS ‚Üí Fedora)

You already captured this well; I‚Äôll just refine it.

Apache (httpd)

macOS (brew)								Fedora
/opt/homebrew/opt/httpd/bin/httpd			/usr/sbin/httpd
Config: /opt/homebrew/etc/httpd/httpd.conf	/etc/httpd/conf/httpd.conf
Modules: bundled via brew					Modules split into packages

‚úÖ Fedora uses prefork MPM + mod_php by default, which matches macOS setup.

PHP

macOS										Fedora
PHP via Homebrew							PHP via DNF
/opt/homebrew/etc/php/8.5/php.ini			/etc/php.ini
libphp.so loaded directly					libphp.so via mod_php

dnf install php php-cli php-common php-gd php-intl php-mysqlnd \
           php-opcache php-pecl-zip php-mbstring

Notes:
	‚Ä¢	php-mcrypt is obsolete ‚Üí do not install
	‚Ä¢	phpMyAdmin should be optional, not core
	‚Ä¢	Imagick (for thumbnails!) will need: dnf install php-pecl-imagick ImageMagick

MySQL

macOS										Fedora
Oracle DMG									dnf install mysql-server
MySQL 9.x									MySQL 8.x (Fedora default)

‚ö†Ô∏è Important:
	‚Ä¢	Fedora does not ship MySQL 9 yet
	‚Ä¢	MySQL 8.0 is 100% compatible with existing schema and dumps
	
Config paths:

Purpose										Fedora
Server config								/etc/my.cnf
Client config								~/.my.cnf

local-infile fix applies exactly the same way on Fedora.

2Ô∏è‚É£ Apache configuration translation (important)

macOS config
DocumentRoot "/Users/bajanp/Projects/BookCatalog/public"
Alias /bookcatalog /Users/bajanp/Projects/BookCatalog/public

Fedora equivalent (recommended)
On Fedora, do not put this directly into httpd.conf. Instead:
/etc/httpd/conf.d/bookcatalog.conf

ServerName localhost

DocumentRoot /var/www/bookcatalog/public

<Directory /var/www/bookcatalog/public>
    AllowOverride All
    Require all granted
</Directory>

Alias /bookcatalog /var/www/bookcatalog/public

Then:

mkdir -p /var/www/bookcatalog
mkdir -p /var/www/bookcatalog/public
chown -R apache:apache /var/www/bookcatalog

üìå Why this matters
Fedora uses SELinux ‚Üí /Users/... paths will fail silently.

4Ô∏è‚É£ PHP configuration parity

max_execution_time = 120
max_input_time = 120
memory_limit = 256M
post_max_size = 25M
file_uploads = On
upload_max_filesize = 20M
max_file_uploads = 20
default_socket_timeout = 120

After changes:
	systemctl restart httpd


‚úÖ Fedora Server Setup Checklist

(BookCatalog / Apache / PHP / MySQL / Images)

1Ô∏è‚É£ Base System

OS
	‚Ä¢	Fedora Core 43 Server
	‚Ä¢	Static hostname set
	hostnamectl set-hostname bookcatalog

Updates
	dnf update -y
	reboot


2Ô∏è‚É£ SELinux (important)

Verify status:
	sestatus

‚úî Current mode: permissive

That is perfect for now.
Do NOT disable SELinux.

Later (optional hardening):
	setenforce enforcing
	

‚∏ª

3Ô∏è‚É£ Apache (httpd)

Install
	dnf install -y httpd mod_ssl

Enable & start
	systemctl enable httpd
	systemctl start httpd

Firewall
	systemctl enable --now firewalld

	firewall-cmd --permanent --add-service=http
	firewall-cmd --permanent --add-service=ssh
	firewall-cmd --permanent --add-service=ftp

	firewall-cmd --reload
	firewall-cmd --list-all

Document root
	chown -R root:root /var/www/bookcatalog
	chmod -R 755 /var/www/bookcatalog
	mkdir -p /var/www/bookcatalog/public
	mkdir -p /var/www/bookcatalog/public/uploads
	chown -R apache:apache /var/www/bookcatalog/public/uploads
	chmod -R 775 /var/www/bookcatalog/public/uploads

4Ô∏è‚É£ Apache VirtualHost (recommended)

Create:
	/etc/httpd/conf.d/bookcatalog.conf
	
	<VirtualHost *:80>
    ServerName localhost
    DocumentRoot /var/www/bookcatalog/public

    <Directory /var/www/bookcatalog/public>
        AllowOverride All
        Require all granted
    </Directory>

    ErrorLog  /var/log/httpd/bookcatalog_error.log
    CustomLog /var/log/httpd/bookcatalog_access.log combined
	</VirtualHost>

Reload:
	systemctl reload httpd

5Ô∏è‚É£ PHP

Install PHP stack

	dnf install -y \
  		php php-cli php-fpm \
  		php-gd php-intl php-mysqlnd php-opcache \
  		php-pecl-zip php-mbstring php-json php-xml \
  		php-pecl-imagick

‚úÖ Imagick does NOT require a LoadModule
	‚Ä¢	It is a PHP extension, not an Apache module
	‚Ä¢	Just installing php-pecl-imagick is enough

Verify:
	php -m | grep imagick

PHP-FPM (recommended)
	systemctl enable php-fpm
	systemctl start php-fpm
	
Apache auto-connects via proxy_fcgi on Fedora.

php.ini settings

File:
	/etc/php.ini

Minimum required (matches macOS setup):
	max_execution_time = 120
	max_input_time = 120
	memory_limit = 256M
	post_max_size = 25M
	upload_max_filesize = 20M
	max_file_uploads = 20
	file_uploads = On
	default_socket_timeout = 120

Restart:
	systemctl restart php-fpm
	systemctl reload httpd

6Ô∏è‚É£ MySQL / MariaDB

Install (Fedora default = MariaDB)
	dnf install -y mariadb-server mariadb

Enable & start
	systemctl enable mariadb
	systemctl start mariadb

Secure setup
	mysql_secure_installation

MySQL config

File:
	/etc/my.cnf.d/local.cnf
	
	[mysqld]
	local-infile=1

	[mysql]
	local-infile=1

Restart:
	systemctl restart mariadb

Verify:
	mysql -e "SHOW VARIABLES LIKE 'local_infile';"
	
7Ô∏è‚É£ Database Restore (BookCatalog)

Restore DB
	systemctl restart mariadb
	mysql < bpbooks-backup.sql

‚úî Safe because dump uses:
	DROP TABLE IF EXISTS

Uploads restore
	cp -a uploads /var/www/bookcatalog/public/
	chown -R apache:apache /var/www/bookcatalog/public/uploads

8Ô∏è‚É£ Permissions (critical)
	chown -R apache:apache /var/www/bookcatalog
	find /var/www/bookcatalog -type d -exec chmod 755 {} \;
	find /var/www/bookcatalog -type f -exec chmod 644 {} \;

SELinux (permissive already, but correct context anyway):
	restorecon -Rv /var/www/bookcatalog

9Ô∏è‚É£ Imagick & Thumbnails
Verify Imagick:
	php -r "new Imagick(); echo 'OK';"

Rebuild thumbs if needed:
	php public/normalize_covers.php --re --h=240
	
üîü Smoke Tests
PHP
	php -v
	php -m | grep imagick
	
Web
	‚Ä¢	http://localhost/
	‚Ä¢	Upload a cover
	‚Ä¢	Generate thumbnail
	‚Ä¢	Login works
	‚Ä¢	CSV import works

Logs
	tail -f /var/log/httpd/bookcatalog_error.log
	tail -f /var/log/php-fpm/error.log
	journalctl -u mariadb

1Ô∏è‚É£1Ô∏è‚É£ Backups (launchd ‚Üí systemd)

If migrating your macOS backup script:
	‚Ä¢	Place script in /usr/local/bin/backup_bpbooks.sh
	‚Ä¢	Create systemd timer:
	/etc/systemd/system/bpbooks-backup.timer
	/etc/systemd/system/bpbooks-backup.service
	
1Ô∏è‚É£2Ô∏è‚É£ Optional Hardening (later)
	‚Ä¢	Switch SELinux to enforcing
	‚Ä¢	Bind Apache only to LAN IP
	‚Ä¢	Disable PHP error display
	‚Ä¢	Read-only user accounts

Import content and DB on Linux
DB:
Create the 'bpbooks' DB:
	mysql -u root -p -e "CREATE DATABASE IF NOT EXISTS bpbooks CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;"

Collation: 'utf8mb4_0900_ai_ci': solved by modified sqldump script

On linux - create DB user 'bajanp'
	CREATE USER 'bajanp'@'localhost' IDENTIFIED BY 'STRONG_PASSWORD_HERE';
	GRANT ALL PRIVILEGES ON bpbooks.* TO 'bajanp'@'localhost';
	FLUSH PRIVILEGES;

Import documents to /var/www/bookcatalog
1. stop apache: 'systemctl stop httpd'
2. upload tgz package
3. create temp directory
4. unpack tgz into temp directory
5. remove frontend and public directories from /var/www/bookcatalog/
	rm -rf /var/www/bookcatalog/frontend /var/www/bookcatalog/public
6. move contents from temp to /var/www/bookcatalog/
	mv /root/bookcatalog-import/* /var/www/bookcatalog/
7. adjust ownership: chown -R apache:apache /var/www/bookcatalog
	chown -R apache:apache /var/www/bookcatalog
8. check and if necessary adjust Alias and Directory in /etc/httpd/conf.d/bookcatalog.conf
9. cd /var/www/bookcatalog/frontend
10. do:
	'npm install @vue/cli-service --save-dev'
	'npm install'
11. build it from there: 
	'npm run build'
12. Verify build output (must contain index.html, js/, css/)
	ls -l /var/www/bookcatalog/public/dist
13. Database & runtime sanity - Ensure DB user exists and matches config.php
	Note: runtime config is now loaded from $HOME/.config/config.php (or via BOOKCATALOG_CONFIG).
	CREATE USER 'bajanp'@'localhost' IDENTIFIED BY '...';
	GRANT ALL PRIVILEGES ON bpbooks.* TO 'bajanp'@'localhost';
	FLUSH PRIVILEGES;
14. Import DB dump before first login
	mysql -u root -p bpbooks < bpbooks-portable.sql
15. Restart services
	systemctl restart mariadb
	systemctl start httpd
16. Checks - open
	http://<linux-ip>/bookcatalog/
17. Verify:
	‚Ä¢	SPA loads (no blank page)
	‚Ä¢	/bookcatalog/login.php returns JSON (no 404)
	‚Ä¢	Login works
	‚Ä¢	Covers visible
	‚Ä¢	Admin actions gated correctly
	
	

‚∏ª

Authors
Internal tooling maintained by Peter Bajan & ChatGPT.
